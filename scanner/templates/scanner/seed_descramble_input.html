{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Seed Descramble Input</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f1f3f5; }
        .form-section {
            background-color: #ffffff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 0 5px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }
        .form-title {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .form-title img {
            height: 60px;
            margin-right: 15px;
        }
        .form-title-text {
            font-size: 1.8rem;
            font-weight: bold;
        }
        .blinking-dot {
            height: 12px;
            width: 12px;
            background-color: red;
            border-radius: 50%;
            display: inline-block;
            margin-left: 10px;
            animation: blink 1s infinite;
            visibility: hidden;
        }
        @keyframes blink { 50% { opacity: 0; } }
        #liveOutput {
            background-color: #000;
            color: #00FF00;
            padding: 1rem;
            border-radius: 0.5rem;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            scroll-behavior: smooth;
        }
        .button-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 2rem;
        }
        .equal-width-btn {
            width: 200px;
        }
    </style>
</head>

<body>
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">

            <div class="form-title">
                <img src="https://danie.capetown/wp-content/uploads/2025/04/ddlogo2_medium.png" alt="Logo">
                <div class="form-title-text">Digital Distillery Seed Descramble</div>
            </div>

            {% if error %}
                <div class="alert alert-danger text-center fs-5">{{ error }}</div>
            {% endif %}

            <form id="descrambleForm" method="post" action="{% url 'seed_descramble_result' %}">
                {% csrf_token %}

                <div class="form-section">
                    <h5>Command String</h5>
                    <textarea id="constructedString" name="constructed_string" class="form-control" rows="4" placeholder="Paste or build command here..."></textarea>
                </div>

                <div class="form-section">
                    <h5>List File</h5>
                    {{ form.tokenlist_file }}
                    <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="reviewListFile()">Review List File</button>
                </div>

                <div class="form-section">
                    <h5>Wallet Type</h5>
                    {{ form.wallet_type }}
                </div>

                <div class="form-section">
                    <h5>Addresses</h5>
                    {{ form.addresses }}
                </div>

                <div class="form-section">
                    <h5>Address Limit</h5>
                    {{ form.address_limit }}
                </div>

                <div class="form-section">
                    <h5>Mnemonic Length</h5>
                    {{ form.mnemonic_length }}
                </div>

                <div class="form-section">
                    <h5>Language</h5>
                    {{ form.language }}
                </div>

                <div class="form-section">
                    <h5>Derivation Path</h5>
                    <select id="derivationDropdown" class="form-select mb-2">
                        <option value="BTC.txt">BTC</option>
                        <option value="ETH.txt">ETH</option>
                        <option value="DOGE.txt">DOGE</option>
                        <option value="LTC.txt">LTC</option>
                        <option value="XRP.txt">XRP</option>
                        <option value="DASH.txt">DASH</option>
                        <option value="DGB.txt">DGB</option>
                        <option value="GRS.txt">GRS</option>
                        <option value="MONA.txt">MONA</option>
                        <option value="ZIL.txt">ZIL</option>
                        <option value="VTC.txt">VTC</option>
                        <option value="Electrum.txt">Electrum</option>
                        <option value="ADA.txt">ADA</option>
                    </select>
                    <button type="button" class="btn btn-sm btn-outline-secondary" onclick="reviewDerivationFile()">Review Default Path</button>
                    <input type="text" id="customDerivationPath" class="form-control mt-2" placeholder="Optional custom bip32 path (e.g. m/44'/0'/0'/0)">
                </div>

                <div class="button-row">
                    <button type="button" class="btn btn-primary btn-lg equal-width-btn" onclick="startRecovery()">Start Recovery</button>
                    <button type="button" id="stopButton" class="btn btn-danger btn-lg equal-width-btn" onclick="stopRecovery()" disabled>Stop Recovery</button>
                </div>
            </form>

            <hr class="my-5">

            <div class="form-section">
                <h5>Live Output <span class="blinking-dot" id="liveIndicator"></span></h5>
                <pre id="liveOutput">Waiting to start...</pre>
                <div class="my-2">
                    <small id="running-time" class="text-muted">Running time: 0 sec</small>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
let recoveryTimer, statusTimer;
let recoveryStartTime;

function reviewListFile() {
    const fileInput = document.querySelector('[name="tokenlist_file"]');
    const filename = fileInput.value.split("\\").pop();
    if (filename) {
        fetch(`/open-list-file/${filename}/`);
    } else {
        alert('Please select a list file first!');
    }
}

function reviewDerivationFile() {
    const selected = document.getElementById('derivationDropdown').value;
    fetch(`/open-derivation-file/${selected}/`);
}

function updateConstructedString() {
    const walletType = document.querySelector('[name="wallet_type"]').value.trim();
    const addresses = document.querySelector('[name="addresses"]').value.trim();
    const addressLimit = document.querySelector('[name="address_limit"]').value.trim();
    const mnemonicLength = document.querySelector('[name="mnemonic_length"]').value.trim();
    const language = document.querySelector('[name="language"]').value.trim().toUpperCase();
    const customPath = document.getElementById('customDerivationPath').value.trim();
    const tokenlistFile = document.querySelector('[name="tokenlist_file"]').value.split('\\').pop();

    let parts = ['--no-dupchecks', '--no-eta', '--dsw'];
    if (walletType) parts.push(`--wallet-type ${walletType}`);
    if (addresses) parts.push(`--addrs ${addresses}`);
    if (addressLimit) parts.push(`--addr-limit ${addressLimit}`);
    if (mnemonicLength) parts.push(`--mnemonic-length ${mnemonicLength}`);
    if (language) parts.push(`--language ${language}`);
    if (customPath) parts.push(`--bip32-path "${customPath}"`);
    if (tokenlistFile) parts.push(`--tokenlist ./btcrecover/dd-lists/${tokenlistFile}`);

    document.getElementById('constructedString').value = parts.join(' ');
}

document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('input', updateConstructedString);
    });
    updateConstructedString();
});

function startRecovery() {
    const args = document.getElementById('constructedString').value.trim();
    if (!args) {
        alert("Paste or build the command first.");
        return;
    }
    fetch(`/descramble/start-recovery/?args=${encodeURIComponent(args)}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                document.getElementById('stopButton').disabled = false;
                document.getElementById('liveIndicator').style.visibility = 'visible';
                startFakeConsole();
                startCheckingStatus();
                recoveryStartTime = new Date();
                statusTimer = setInterval(updateRunningTime, 1000);
            } else {
                alert("Failed to start recovery: " + data.error);
            }
        });
}

function stopRecovery() {
    fetch("/descramble/stop-recovery/")
        .then(res => res.json())
        .then(data => {
            clearInterval(recoveryTimer);
            clearInterval(statusTimer);
            document.getElementById('stopButton').disabled = true;
            document.getElementById('liveIndicator').style.visibility = 'hidden';
        });
}

function startFakeConsole() {
    const output = document.getElementById('liveOutput');
    output.textContent = 'Recovery started...\n';
    function pulse() {
        const now = new Date();
        const timestamp = now.toLocaleTimeString([], {hour12: false});
        output.textContent += `[${timestamp}] Recovery in progress...\n`;
        output.scrollTop = output.scrollHeight;
    }
    pulse();
    recoveryTimer = setInterval(pulse, 5 * 60 * 1000);
}

function updateRunningTime() {
    const now = new Date();
    const elapsedMs = now - recoveryStartTime;
    const minutes = Math.floor(elapsedMs / 60000);
    const seconds = Math.floor((elapsedMs % 60000) / 1000);
    document.getElementById('running-time').textContent = `Running time: ${minutes > 0 ? minutes + ' min ' : ''}${seconds} sec`;
}

function startCheckingStatus() {
    setInterval(() => {
        fetch("/descramble/check-recovery-status/")
            .then(res => res.json())
            .then(data => {
                if (data.status === 'finished') {
                    clearInterval(recoveryTimer);
                    clearInterval(statusTimer);
                    document.getElementById('liveIndicator').style.visibility = 'hidden';
                    setTimeout(() => {
                        window.location.href = "{% url 'seed_descramble_result' %}";
                    }, 2000);
                }
            });
    }, 3000);
}
</script>

</body>
</html>
