{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Seed Repair Input</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f1f3f5; }
        .form-section {
            background-color: #f8f9fa;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 0 5px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
        }
        .form-title {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
        }
        .form-title img {
            height: 60px;
            margin-right: 15px;
        }
        .form-title-text {
            font-size: 1.8rem;
            font-weight: 600;
        }
        .form-control { background-color: #ffffff; }
        #liveOutput {
            background-color: #000;
            color: #00ff00;
            padding: 1rem;
            border-radius: 0.5rem;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            scroll-behavior: smooth;
        }
        @keyframes blink {
            to { visibility: hidden; }
        }
        .equal-width-btn {
            width: 200px;
        }
        .button-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 2rem;
        }
    </style>
</head>

<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-10 col-lg-8">

            <div class="form-title">
                <img src="https://danie.capetown/wp-content/uploads/2025/04/ddlogo2_medium.png" alt="Logo">
                <div class="form-title-text">Digital Distillery Seed Repair</div>
            </div>

            {% if error %}
                <div class="alert alert-danger text-center fs-5">{{ error }}</div>
            {% endif %}

            <form id="repairForm" method="post" action="{% url 'seed_repair_result' %}" enctype="multipart/form-data">
                {% csrf_token %}

                <div class="form-section">
                    <h4>Seed Phrase</h4>
                    {{ form.seed_phrase }}
                </div>

                <div class="form-section">
                    <h4>Command String (Optional)</h4>
                    {{ form.constructed_string }}
                    <small class="text-muted">Leave empty if filling above fields.</small>
                </div>

                <div class="button-row">
                    <button type="button" class="btn btn-primary btn-lg equal-width-btn" onclick="startRecovery()">
                        Start Seed Repair
                    </button>

                    <button type="button" id="stopButton" class="btn btn-danger btn-lg equal-width-btn" onclick="stopRecovery()" disabled>
                        Stop Recovery
                    </button>
                </div>

            </form>

            <hr class="my-5">

            <div class="form-section">
                <h4>Live Output</h4>
                <pre id="liveOutput">Waiting to start...</pre>
            </div>

        </div>
    </div>
</div>

<audio id="successSound" src="{% static 'sounds/success.wav' %}"></audio>

<!-- JavaScript -->
<script>
let recoveryTimer = null;
let dotsTimer = null;
let statusTimer = null;
let dots = '';

function startRecovery() {
    const constructedArgs = document.getElementById('id_constructed_string').value.trim();
    if (!constructedArgs) {
        alert("Please paste or build a command string first.");
        return;
    }

    fetch(`/repair/start-recovery/?args=${encodeURIComponent(constructedArgs)}`)
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                startFakeConsole();
                document.getElementById('stopButton').disabled = false;
                startCheckingStatus();
            } else {
                alert("Failed to start recovery: " + data.error);
            }
        })
        .catch(err => {
            console.error(err);
            alert("Something went wrong.");
        });
}

function stopRecovery() {
    fetch("/repair/stop-recovery/")
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                stopFakeConsole();
                stopCheckingStatus();
                document.getElementById('stopButton').disabled = true;
            } else {
                alert("Failed to stop recovery: " + data.error);
            }
        });
}

function startFakeConsole() {
    const output = document.getElementById('liveOutput');
    output.textContent = '';

    function appendPulse() {
        const now = new Date();
        const timestamp = now.toLocaleTimeString([], {hour12: false});
        output.textContent += `\n[${timestamp}] Recovery in progress...`;
        output.scrollTop = output.scrollHeight;
    }

    function animateDots() {
        dots += '.';
        if (dots.length > 3) dots = '.';
        output.textContent = output.textContent.replace(/(\.\.\.)?$/, dots);
        output.scrollTop = output.scrollHeight;
    }

    appendPulse();
    recoveryTimer = setInterval(appendPulse, 5 * 60 * 1000);
    dotsTimer = setInterval(animateDots, 500);
}

function stopFakeConsole(finalMessage = "⛔ Recovery stopped.") {
    clearInterval(recoveryTimer);
    clearInterval(dotsTimer);
    const output = document.getElementById('liveOutput');
    const now = new Date();
    const timestamp = now.toLocaleTimeString([], {hour12: false});
    output.textContent += `\n[${timestamp}] ${finalMessage}`;
    output.scrollTop = output.scrollHeight;
}

function startCheckingStatus() {
    statusTimer = setInterval(() => {
        fetch("/repair/check-recovery-status/")
            .then(res => res.json())
            .then(data => {
                if (data.status === 'finished') {
                    clearInterval(statusTimer);
                    stopFakeConsole("✅ Recovery complete!");

                    // ✅ Play sound
                    const sound = document.getElementById('successSound');
                    sound.play();

                    setTimeout(() => {
                        window.location.href = "{% url 'seed_repair_result' %}";
                    }, 2500);
                }
            })
            .catch(console.error);
    }, 3000);
}

function stopCheckingStatus() {
    clearInterval(statusTimer);
}
</script>

</body>
</html>
